ARG TAG=latest
FROM ghcr.io/kokkos/ci-containers/fedora:${TAG}

USER root
RUN ( dnf -y update || dnf -y update ) && \
    dnf -y install \
      openmpi-devel fftw-devel doxygen valgrind libasan && \
    dnf clean all

# Install Googletest
ENV GTEST_DIR=/opt/gtest
ARG GTEST_VERSION=release-1.11.0
RUN GTEST_URL=https://github.com/google/googletest/archive/${GTEST_VERSION}.tar.gz && \
    GTEST_ARCHIVE=gtest-${GTEST_VERSION}.tar.gz && \
    SCRATCH_DIR=/scratch && mkdir -p ${SCRATCH_DIR} && cd ${SCRATCH_DIR} && \
    wget --quiet ${GTEST_URL} --output-document=${GTEST_ARCHIVE} && \
    mkdir -p gtest && \
    tar -xf ${GTEST_ARCHIVE} -C gtest --strip-components=1 && \
    cd gtest && \
    mkdir -p build && cd build && \
    cmake \
      -D CMAKE_INSTALL_PREFIX=${GTEST_DIR} \
    .. && \
    make -j${NPROCS} install && \
    rm -rf ${SCRATCH_DIR}

USER kokkos
ENV PATH=${PATH}${PATH:+:}/usr/lib64/openmpi/bin
